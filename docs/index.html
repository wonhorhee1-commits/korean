<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>한국어 코치 — Korean Coach</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #232733;
  --border: #2d3348;
  --text: #e4e4e7;
  --dim: #71717a;
  --blue: #60a5fa;
  --cyan: #22d3ee;
  --green: #4ade80;
  --red: #f87171;
  --yellow: #facc15;
  --magenta: #c084fc;
  --orange: #fb923c;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.container {
  max-width: 680px;
  width: 100%;
  padding: 20px;
}

h1 {
  text-align: center;
  font-size: 2em;
  margin: 30px 0 5px;
  color: #fff;
}

.subtitle {
  text-align: center;
  color: var(--dim);
  margin-bottom: 30px;
  font-size: 0.95em;
}

.stats-bar {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-bottom: 25px;
  color: var(--dim);
  font-size: 0.85em;
}

.stats-bar span { color: var(--cyan); }

/* Menu */
.menu {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 20px 0;
}

.menu button {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 16px 20px;
  border-radius: 10px;
  font-size: 1.05em;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 12px;
}

.menu button:hover {
  background: var(--surface2);
  border-color: var(--blue);
}

.menu button .num {
  color: var(--cyan);
  font-weight: bold;
  min-width: 24px;
}

/* Card */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
  margin: 15px 0;
  text-align: center;
}

.card-korean {
  font-size: 2em;
  font-weight: bold;
  color: #fff;
  margin-bottom: 8px;
}

.card-hint {
  color: var(--dim);
  font-style: italic;
  font-size: 0.9em;
}

.card-prompt {
  color: var(--dim);
  margin: 15px 0 20px;
  font-size: 0.95em;
}

.card-english {
  font-size: 1.8em;
  font-weight: bold;
  color: #fff;
  margin-bottom: 8px;
}

/* Answer area */
.answer-input {
  width: 100%;
  padding: 14px 18px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 1.05em;
  outline: none;
  transition: border-color 0.15s;
}

.answer-input:focus {
  border-color: var(--blue);
}

.answer-input::placeholder {
  color: var(--dim);
}

/* Reveal */
.reveal {
  background: var(--surface);
  border: 1px solid var(--blue);
  border-radius: 12px;
  padding: 20px 25px;
  margin: 15px 0;
}

.reveal-answer {
  font-size: 1.2em;
  font-weight: bold;
  color: #fff;
  margin-bottom: 6px;
}

.reveal-notes {
  color: var(--dim);
  font-size: 0.9em;
  line-height: 1.5;
}

.breakdown {
  color: var(--magenta);
  font-size: 0.95em;
  margin: 10px 0;
}

.breakdown::before {
  content: '한자 breakdown: ';
  font-weight: bold;
}

.example {
  margin: 12px 0;
  padding-left: 12px;
  border-left: 2px solid var(--yellow);
}

.example-kr {
  color: var(--yellow);
  font-style: italic;
  font-size: 1em;
}

.example-en {
  color: var(--dim);
  font-size: 0.9em;
  margin-top: 2px;
}

/* Result for fill-in drills */
.result-correct {
  border-color: var(--green);
}
.result-correct .reveal-answer::before {
  content: '✓ Correct! ';
  color: var(--green);
}
.result-incorrect {
  border-color: var(--red);
}
.result-incorrect .reveal-answer::before {
  content: '✗ Incorrect — ';
  color: var(--red);
}

/* Rating buttons */
.rating {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.rating button {
  flex: 1;
  min-width: 120px;
  padding: 12px 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.95em;
}

.rating button:hover { transform: translateY(-1px); }

.rating .btn-again { border-color: var(--red); }
.rating .btn-again:hover { background: rgba(248,113,113,0.15); }
.rating .btn-again .label { color: var(--red); font-weight: bold; }

.rating .btn-hard { border-color: var(--orange); }
.rating .btn-hard:hover { background: rgba(251,146,60,0.15); }
.rating .btn-hard .label { color: var(--orange); font-weight: bold; }

.rating .btn-good { border-color: var(--green); }
.rating .btn-good:hover { background: rgba(74,222,128,0.15); }
.rating .btn-good .label { color: var(--green); font-weight: bold; }

.rating .btn-easy { border-color: var(--cyan); }
.rating .btn-easy:hover { background: rgba(34,211,238,0.15); }
.rating .btn-easy .label { color: var(--cyan); font-weight: bold; }

.rating .desc { color: var(--dim); font-size: 0.8em; }

/* Progress bar */
.progress-bar {
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  margin: 15px 0;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--blue);
  border-radius: 2px;
  transition: width 0.3s;
}

/* Category selector */
.categories {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 15px 0;
}

.categories button {
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.15s;
}

.categories button:hover, .categories button.active {
  background: var(--surface2);
  border-color: var(--blue);
  color: var(--blue);
}

/* Session summary */
.summary {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  margin: 20px 0;
}

.summary h2 { margin-bottom: 15px; color: var(--blue); }

.summary-stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 15px 0;
}

.summary-stat {
  text-align: center;
}

.summary-stat .value {
  font-size: 1.8em;
  font-weight: bold;
}

.summary-stat .label {
  color: var(--dim);
  font-size: 0.85em;
}

.comment {
  color: var(--dim);
  font-style: italic;
  margin-top: 10px;
}

/* Progress view */
.progress-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

.progress-table th, .progress-table td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.progress-table th {
  color: var(--cyan);
  font-size: 0.85em;
  text-transform: uppercase;
}

.progress-table td {
  font-size: 0.95em;
}

/* Buttons */
.btn {
  padding: 12px 24px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 1em;
  transition: all 0.15s;
}

.btn:hover {
  background: var(--surface2);
  border-color: var(--blue);
}

.btn-primary {
  background: var(--blue);
  border-color: var(--blue);
  color: #000;
  font-weight: bold;
}

.btn-primary:hover {
  background: #93bbfd;
}

.back-btn {
  background: none;
  border: none;
  color: var(--dim);
  cursor: pointer;
  font-size: 0.9em;
  padding: 8px 0;
  margin-bottom: 10px;
}

.back-btn:hover { color: var(--text); }

.counter {
  color: var(--dim);
  font-size: 0.85em;
  text-align: right;
  margin-bottom: 10px;
}

.fill-prompt {
  color: var(--cyan);
  font-weight: bold;
  margin: 15px 0 8px;
}

.fill-sentence {
  color: var(--text);
  margin-bottom: 12px;
  font-size: 1.05em;
}

.your-guess {
  color: var(--dim);
  font-size: 0.95em;
  margin: 10px 0;
  padding: 10px 14px;
  background: var(--surface2);
  border-radius: 8px;
}

.your-guess span {
  color: var(--text);
  font-weight: bold;
}

.hidden { display: none; }

/* Keyboard shortcuts hint */
.shortcuts {
  color: var(--dim);
  font-size: 0.8em;
  text-align: center;
  margin: 5px 0;
}

@media (max-width: 600px) {
  .container { padding: 12px; }
  .card-korean { font-size: 1.5em; }
  .card-english { font-size: 1.3em; }
  .rating { flex-direction: column; }
  .rating button { min-width: unset; }
  h1 { font-size: 1.5em; }
}
.sync-status {
  text-align: center;
  font-size: 0.8em;
  color: var(--dim);
  margin-bottom: 5px;
}
.sync-status.synced { color: var(--green); }
.sync-status.syncing { color: var(--yellow); }
.sync-status.offline { color: var(--dim); }
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container" id="app">
  <!-- Populated by JS -->
</div>

<script>
// ===== SRS ENGINE =====
const AGAIN = 0, HARD = 2, GOOD = 3, EASY = 5;

class Card {
  constructor(data = {}) {
    this.card_id = data.card_id || '';
    this.ease_factor = data.ease_factor || 2.5;
    this.interval_days = data.interval_days || 0;
    this.repetitions = data.repetitions || 0;
    this.next_review = data.next_review || 0;
    this.last_review = data.last_review || 0;
    this.total_reviews = data.total_reviews || 0;
    this.correct_count = data.correct_count || 0;
  }

  get accuracy() {
    return this.total_reviews === 0 ? 0 : this.correct_count / this.total_reviews;
  }

  review(quality) {
    const now = Date.now() / 1000;
    this.last_review = now;
    this.total_reviews++;
    if (quality >= GOOD) this.correct_count++;

    if (quality < GOOD) {
      this.repetitions = 0;
      this.interval_days = 0.007;
    } else {
      if (this.repetitions === 0) this.interval_days = 0.04;
      else if (this.repetitions === 1) this.interval_days = 1;
      else if (this.repetitions === 2) this.interval_days = 3;
      else this.interval_days *= this.ease_factor;
      this.repetitions++;
    }

    this.ease_factor += 0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02);
    this.ease_factor = Math.max(1.3, this.ease_factor);
    this.next_review = now + this.interval_days * 86400;
  }
}

class SRSEngine {
  constructor() {
    this.cards = {};
    this._load();
  }

  _load() {
    try {
      const data = JSON.parse(localStorage.getItem('korean_coach_srs') || '{}');
      for (const [id, d] of Object.entries(data)) this.cards[id] = new Card(d);
    } catch(e) {}
  }

  save() {
    localStorage.setItem('korean_coach_srs', JSON.stringify(this.cards));
    pushToFirestore(); // async, non-blocking
  }

  getCard(id) {
    if (!this.cards[id]) this.cards[id] = new Card({card_id: id});
    return this.cards[id];
  }

  getDueCards(ids) {
    const now = Date.now() / 1000;
    const due = [], newCards = [];
    for (const id of ids) {
      if (!this.cards[id]) newCards.push(id);
      else if (this.cards[id].next_review <= now) due.push(id);
    }
    due.sort((a, b) => this.cards[a].next_review - this.cards[b].next_review);
    return [...due, ...newCards];
  }

  recordReview(id, quality) {
    this.getCard(id).review(quality);
    this.save();
  }

  getStats() {
    const now = Date.now() / 1000;
    const cards = Object.values(this.cards);
    const total = cards.length;
    if (total === 0) return {total: 0, due: 0, learning: 0, mature: 0, accuracy: 0};
    return {
      total,
      due: cards.filter(c => c.next_review <= now).length,
      learning: cards.filter(c => c.interval_days < 7).length,
      mature: cards.filter(c => c.interval_days >= 7).length,
      accuracy: cards.reduce((s,c) => s + c.correct_count, 0) / Math.max(1, cards.reduce((s,c) => s + c.total_reviews, 0))
    };
  }
}

// ===== FIREBASE SYNC =====
const FIREBASE_CONFIG = {
  // PASTE YOUR FIREBASE CONFIG HERE (see README)
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

let db = null, userId = null, syncEnabled = false;

async function initFirebase() {
  if (!FIREBASE_CONFIG.apiKey) return; // Skip if not configured
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    const auth = firebase.auth();
    const cred = await auth.signInAnonymously();
    userId = cred.user.uid;
    // Persist anonymous user across sessions
    localStorage.setItem('korean_coach_uid', userId);
    syncEnabled = true;
    updateSyncStatus('synced', 'Synced');
    // Pull remote data on login
    await pullFromFirestore();
  } catch(e) {
    console.warn('Firebase init failed, using local only:', e);
    updateSyncStatus('offline', 'Local only');
  }
}

async function pushToFirestore() {
  if (!syncEnabled || !db || !userId) return;
  try {
    updateSyncStatus('syncing', 'Syncing...');
    const data = JSON.parse(localStorage.getItem('korean_coach_srs') || '{}');
    // Firestore doc size limit is 1MB, split into chunks if needed
    await db.collection('users').doc(userId).set({
      srs: JSON.stringify(data),
      updated: firebase.firestore.FieldValue.serverTimestamp()
    });
    updateSyncStatus('synced', 'Synced');
  } catch(e) {
    console.warn('Firestore push failed:', e);
    updateSyncStatus('offline', 'Sync failed');
  }
}

async function pullFromFirestore() {
  if (!syncEnabled || !db || !userId) return;
  try {
    const doc = await db.collection('users').doc(userId).get();
    if (doc.exists && doc.data().srs) {
      const remote = JSON.parse(doc.data().srs);
      const local = JSON.parse(localStorage.getItem('korean_coach_srs') || '{}');
      // Merge: keep whichever card has the later last_review
      const merged = {...local};
      for (const [id, rCard] of Object.entries(remote)) {
        if (!merged[id] || (rCard.last_review || 0) > (merged[id].last_review || 0)) {
          merged[id] = rCard;
        }
      }
      localStorage.setItem('korean_coach_srs', JSON.stringify(merged));
      srs._load(); // Reload SRS engine from updated localStorage
    }
  } catch(e) {
    console.warn('Firestore pull failed:', e);
  }
}

function updateSyncStatus(cls, text) {
  const el = document.getElementById('sync-status');
  if (el) { el.className = 'sync-status ' + cls; el.textContent = text; }
}

// ===== APP =====
const app = document.getElementById('app');
const srs = new SRSEngine();
let vocabData = {}, grammarData = {};

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ===== SCREENS =====
function countTotal() {
  let v = 0, g = 0;
  for (const entries of Object.values(vocabData)) v += entries.length;
  for (const entries of Object.values(grammarData)) g += entries.length;
  return {vocab: v, grammar: g, total: v + g, cats: Object.keys(vocabData).length + Object.keys(grammarData).length};
}

function showMenu() {
  const stats = srs.getStats();
  const totals = countTotal();
  const reviewedPct = totals.total > 0 ? Math.round(stats.total / totals.total * 100) : 0;

  const statsHtml = `
    <div class="stats-bar">
      <span>${totals.vocab.toLocaleString()}</span> vocab &nbsp;|&nbsp;
      <span>${totals.grammar}</span> grammar &nbsp;|&nbsp;
      <span>${totals.cats}</span> categories
    </div>
    ${stats.total > 0 ? `<div class="stats-bar">
      Reviewed: <span>${stats.total}/${totals.total}</span> (${reviewedPct}%) &nbsp;|&nbsp;
      Due: <span>${stats.due}</span> &nbsp;|&nbsp;
      Accuracy: <span>${Math.round(stats.accuracy * 100)}%</span>
    </div>` : ''}`;

  const syncHtml = syncEnabled ? '<div id="sync-status" class="sync-status synced">Synced</div>'
    : FIREBASE_CONFIG.apiKey ? '<div id="sync-status" class="sync-status offline">Connecting...</div>'
    : '<div id="sync-status" class="sync-status offline">Local only</div>';

  app.innerHTML = `
    <h1>한국어 코치</h1>
    <p class="subtitle">Korean Coach — Advanced Fluency Trainer</p>
    ${syncHtml}
    ${statsHtml}
    <div class="menu">
      <button onclick="showCategorySelect('vocab')"><span class="num">1</span> Vocabulary Drill</button>
      <button onclick="showCategorySelect('grammar')"><span class="num">2</span> Grammar Practice</button>
      <button onclick="startMixedReview()"><span class="num">3</span> Mixed Review (weakest first)</button>
      <button onclick="showProgress()"><span class="num">4</span> View Progress</button>
    </div>
    <div class="shortcuts">Keyboard: 1-4 to select</div>`;

  document.onkeydown = e => {
    if (e.key === '1') showCategorySelect('vocab');
    else if (e.key === '2') showCategorySelect('grammar');
    else if (e.key === '3') startMixedReview();
    else if (e.key === '4') showProgress();
  };
}

function showCategorySelect(type) {
  const data = type === 'vocab' ? vocabData : grammarData;
  const cats = Object.keys(data);
  const title = type === 'vocab' ? 'Vocabulary Drill' : 'Grammar Practice';

  app.innerHTML = `
    <button class="back-btn" onclick="showMenu()">← Back</button>
    <h2 style="margin-bottom:15px">${title}</h2>
    <div class="menu">
      <button onclick="startDrill('${type}', null)"><span class="num">0</span> All Categories</button>
      ${cats.map((c, i) => `<button onclick="startDrill('${type}', '${escHtml(c)}')"><span class="num">${i+1}</span> ${escHtml(c)}</button>`).join('')}
    </div>`;
  document.onkeydown = e => { if (e.key === 'Escape') showMenu(); };
}

function buildPool(type, category) {
  const data = type === 'vocab' ? vocabData : grammarData;
  const cats = category ? [category] : Object.keys(data);
  const pool = [];
  for (const cat of cats) {
    if (!data[cat]) continue;
    for (let i = 0; i < data[cat].length; i++) {
      pool.push({id: `${type}:${cat}:${i}`, type, cat, entry: data[cat][i]});
    }
  }
  return pool;
}

function prioritizeCards(pool, limit) {
  const ids = pool.map(p => p.id);
  const dueSet = new Set(srs.getDueCards(ids));
  const due = shuffle(pool.filter(p => dueSet.has(p.id))).slice(0, limit);
  if (due.length < limit) {
    const rest = shuffle(pool.filter(p => !dueSet.has(p.id)));
    due.push(...rest.slice(0, limit - due.length));
  }
  return due;
}

// ===== DRILL ENGINE =====
function startDrill(type, category) {
  const pool = buildPool(type, category);
  const session = prioritizeCards(pool, 15);
  if (session.length === 0) { showMenu(); return; }
  runSession(session);
}

function startMixedReview() {
  const vPool = buildPool('vocab', null);
  const gPool = buildPool('grammar', null);
  const pool = [...vPool, ...gPool];
  const session = prioritizeCards(pool, 15);
  if (session.length === 0) { showMenu(); return; }
  runSession(session);
}

function runSession(cards) {
  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= cards.length) { showSummary(reviewed, correct); return; }
    const {id, type, cat, entry} = cards[idx];
    const progress = `${idx + 1}/${cards.length}`;
    const pct = ((idx) / cards.length * 100).toFixed(0);

    if (type === 'vocab') showVocabCard(id, cat, entry, progress, pct);
    else showGrammarCard(id, cat, entry, progress, pct);
  }

  function showVocabCard(id, cat, entry, progress, pct) {
    const isComparison = entry.korean.includes(' vs ');
    const showKorean = isComparison || Math.random() < 0.5;

    const prompt = showKorean
      ? `<div class="card"><div class="card-korean">${escHtml(entry.korean)}</div>
         ${entry.hanja ? `<div class="card-hint">${escHtml(entry.hanja)}</div>` : ''}
         </div><div class="card-prompt">What does this mean?</div>`
      : `<div class="card"><div class="card-english">${escHtml(entry.english).replace(/\n/g,'<br>')}</div>
         </div><div class="card-prompt">What is this in Korean?</div>`;

    const answer = showKorean ? entry.english : entry.korean;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">← Quit</button>
      <div class="counter">${escHtml(cat)} &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${prompt}
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    input.onkeydown = e => {
      if (e.key === 'Enter') revealVocab(id, cat, entry, answer, input.value.trim(), progress, pct);
      if (e.key === 'Escape') showMenu();
    };
  }

  function revealVocab(id, cat, entry, answer, guess, progress, pct) {
    let extra = '';
    if (entry.breakdown) extra += `<div class="breakdown">${escHtml(entry.breakdown)}</div>`;
    if (entry.notes) extra += `<div class="reveal-notes">${escHtml(entry.notes)}</div>`;
    if (entry.example) extra += `<div class="example"><div class="example-kr">${escHtml(entry.example)}</div>
      ${entry.example_en ? `<div class="example-en">${escHtml(entry.example_en)}</div>` : ''}</div>`;

    const guessHtml = guess ? `<div class="your-guess">Your answer: <span>${escHtml(guess)}</span></div>` : '';

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">← Quit</button>
      <div class="counter">${escHtml(cat)} &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${guessHtml}
      <div class="reveal"><div class="reveal-answer">${escHtml(answer).replace(/\n/g,'<br>')}</div>${extra}</div>
      ${ratingButtons()}`;
    setupRating(id);
  }

  function showGrammarCard(id, cat, entry, progress, pct) {
    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">← Quit</button>
      <div class="counter">${escHtml(cat)} &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="card"><div class="card-korean">${escHtml(entry.pattern)}</div></div>
      <div class="card-prompt">What does this pattern mean?</div>
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    input.onkeydown = e => {
      if (e.key === 'Enter') revealGrammar(id, cat, entry, input.value.trim(), progress, pct);
      if (e.key === 'Escape') showMenu();
    };
  }

  function revealGrammar(id, cat, entry, guess, progress, pct) {
    let examplesHtml = '';
    for (const ex of (entry.examples || [])) {
      examplesHtml += `<div class="example"><div class="example-kr">${escHtml(ex.korean)}</div>
        ${ex.english ? `<div class="example-en">${escHtml(ex.english)}</div>` : ''}</div>`;
    }

    let drillHtml = '';
    if (entry.drill) {
      drillHtml = `
        <div class="fill-prompt">Fill in the blank:</div>
        <div class="fill-sentence">${escHtml(entry.drill.prompt)}</div>
        <input class="answer-input" id="drill-input" placeholder="Your answer" autofocus>
        <div id="drill-result" class="hidden"></div>`;
    }

    const guessHtml = guess ? `<div class="your-guess">Your answer: <span>${escHtml(guess)}</span></div>` : '';

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">← Quit</button>
      <div class="counter">${escHtml(cat)} &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${((idx)/cards.length*100).toFixed(0)}%"></div></div>
      ${guessHtml}
      <div class="reveal">
        <div class="reveal-answer">${escHtml(entry.meaning)}</div>
        <div class="reveal-notes">${escHtml(entry.explanation)}</div>
      </div>
      ${examplesHtml}
      ${drillHtml}
      ${entry.drill ? '' : ratingButtons()}`;

    if (entry.drill) {
      const di = document.getElementById('drill-input');
      di.focus();
      di.onkeydown = e => {
        if (e.key === 'Enter') {
          const isCorrect = di.value.trim() === entry.drill.answer;
          document.getElementById('drill-result').innerHTML = `
            <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}" style="margin-top:12px">
              <div class="reveal-answer">${escHtml(entry.drill.answer)}</div>
            </div>
            <div class="example"><div class="example-kr">${escHtml(entry.drill.full_sentence)}</div></div>
            ${ratingButtons()}`;
          document.getElementById('drill-result').classList.remove('hidden');
          di.disabled = true;
          setupRating(id);
        }
        if (e.key === 'Escape') showMenu();
      };
    } else {
      setupRating(id);
    }
  }

  function ratingButtons() {
    return `
      <div class="rating">
        <button class="btn-again" data-q="${AGAIN}"><div class="label">Again</div><div class="desc">didn't know</div></button>
        <button class="btn-hard" data-q="${HARD}"><div class="label">Hard</div><div class="desc">struggled</div></button>
        <button class="btn-good" data-q="${GOOD}"><div class="label">Good</div><div class="desc">knew it</div></button>
        <button class="btn-easy" data-q="${EASY}"><div class="label">Easy</div><div class="desc">effortless</div></button>
      </div>
      <div class="shortcuts">Keyboard: 1=Again  2=Hard  3=Good  4=Easy</div>`;
  }

  function setupRating(id) {
    document.querySelectorAll('.rating button').forEach(btn => {
      btn.onclick = () => rate(id, parseInt(btn.dataset.q));
    });
    document.onkeydown = e => {
      const map = {'1': AGAIN, '2': HARD, '3': GOOD, '4': EASY};
      if (map[e.key] !== undefined) rate(id, map[e.key]);
      if (e.key === 'Escape') showMenu();
    };
  }

  function rate(id, quality) {
    srs.recordReview(id, quality);
    reviewed++;
    if (quality >= GOOD) correct++;
    idx++;
    showCard();
  }

  showCard();
}

function showSummary(reviewed, correct) {
  const acc = reviewed > 0 ? correct / reviewed : 0;
  let comment, color;
  if (acc >= 0.9) { comment = 'Excellent.'; color = 'var(--green)'; }
  else if (acc >= 0.7) { comment = 'Solid, but room to sharpen.'; color = 'var(--yellow)'; }
  else if (acc >= 0.5) { comment = 'Getting there. Keep drilling.'; color = 'var(--orange)'; }
  else { comment = "These need more work. They'll come back."; color = 'var(--red)'; }

  app.innerHTML = `
    <div class="summary">
      <h2>Session Complete</h2>
      <div class="summary-stats">
        <div class="summary-stat"><div class="value">${reviewed}</div><div class="label">Reviewed</div></div>
        <div class="summary-stat"><div class="value">${correct}</div><div class="label">Correct</div></div>
        <div class="summary-stat"><div class="value" style="color:${color}">${Math.round(acc*100)}%</div><div class="label">Accuracy</div></div>
      </div>
      <div class="comment">${comment}</div>
    </div>
    <button class="btn btn-primary" onclick="showMenu()" style="width:100%">Back to Menu</button>`;
  document.onkeydown = e => { if (e.key === 'Enter' || e.key === 'Escape') showMenu(); };
}

function showProgress() {
  const stats = srs.getStats();
  const cards = Object.values(srs.cards);
  const weak = [...cards].sort((a,b) => a.ease_factor - b.ease_factor).slice(0, 15);

  let weakRows = '';
  for (const c of weak) {
    const parts = c.card_id.split(':');
    let label = c.card_id;
    try {
      const type = parts[0], cat = parts[1], idx = parseInt(parts[2]);
      const data = type === 'vocab' ? vocabData : grammarData;
      if (data[cat] && data[cat][idx]) {
        label = type === 'vocab' ? data[cat][idx].korean : data[cat][idx].pattern;
      }
    } catch(e) {}
    weakRows += `<tr><td>${escHtml(label)}</td><td>${Math.round(c.accuracy*100)}%</td><td>${c.total_reviews}</td><td>${c.ease_factor.toFixed(1)}</td></tr>`;
  }

  app.innerHTML = `
    <button class="back-btn" onclick="showMenu()">← Back</button>
    <h2 style="margin-bottom:20px">Progress</h2>
    <div class="summary-stats" style="margin-bottom:25px">
      <div class="summary-stat"><div class="value" style="color:var(--cyan)">${stats.total}</div><div class="label">Cards Seen</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--yellow)">${stats.due}</div><div class="label">Due Now</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--green)">${stats.mature}</div><div class="label">Mature</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--blue)">${Math.round(stats.accuracy*100)}%</div><div class="label">Accuracy</div></div>
    </div>
    ${weak.length > 0 ? `
      <h3 style="margin-bottom:10px;color:var(--dim)">Weakest Cards</h3>
      <table class="progress-table">
        <tr><th>Card</th><th>Accuracy</th><th>Reviews</th><th>Ease</th></tr>
        ${weakRows}
      </table>` : '<p style="color:var(--dim)">No cards reviewed yet. Start a drill!</p>'}
    <button class="btn" onclick="if(confirm('Reset all progress?')){localStorage.removeItem('korean_coach_srs');location.reload()}" style="margin-top:20px;color:var(--red);border-color:var(--red)">Reset Progress</button>`;
  document.onkeydown = e => { if (e.key === 'Escape') showMenu(); };
}

// ===== LOAD DATA =====
async function init() {
  app.innerHTML = '<h1>한국어 코치</h1><p class="subtitle">Loading...</p>';
  try {
    const [vResp, gResp] = await Promise.all([
      fetch('data/vocab.json'),
      fetch('data/grammar.json')
    ]);
    vocabData = await vResp.json();
    grammarData = await gResp.json();
  } catch(e) {
    try {
      const [vResp, gResp] = await Promise.all([
        fetch('../data/vocab.json'),
        fetch('../data/grammar.json')
      ]);
      vocabData = await vResp.json();
      grammarData = await gResp.json();
    } catch(e2) {
      app.innerHTML = '<h1>Error</h1><p>Could not load data files.</p>';
      return;
    }
  }
  await initFirebase();
  showMenu();
}

init();
</script>
</body>
</html>
